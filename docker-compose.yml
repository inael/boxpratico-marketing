services:
  traefik:
    image: "traefik:v3.1"
    restart: always
    command:
      - "--api=true"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.mytlschallenge.acme.tlschallenge=true"
      - "--certificatesresolvers.mytlschallenge.acme.email=${SSL_EMAIL}"
      - "--certificatesresolvers.mytlschallenge.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - traefik_data:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro

  n8n:
    image: docker.n8n.io/n8nio/n8n:1.122.5
    restart: always
    environment:
      - N8N_HOST=${SUBDOMAIN}.${DOMAIN_NAME}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - N8N_EDITOR_BASE_URL=https://${SUBDOMAIN}.${DOMAIN_NAME}/
      - WEBHOOK_URL=https://${SUBDOMAIN}.${DOMAIN_NAME}/
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`${SUBDOMAIN}.${DOMAIN_NAME}`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls.certresolver=mytlschallenge"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
    volumes:
      - n8n_data:/home/node/.n8n

  evolution-api:
    image: atendai/evolution-api:v2.2.3
    restart: always
    depends_on:
      - evolution-redis
      - evolution-postgres
    environment:
      - SERVER_URL=https://whatsapp.${DOMAIN_NAME}
      - SERVER_TYPE=http
      - SERVER_PORT=8080
      - AUTHENTICATION_TYPE=apikey
      - AUTHENTICATION_API_KEY=${EVOLUTION_API_KEY}
      - AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES=true
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://postgres:${POSTGRES_PASSWORD}@evolution-postgres:5432/evolution?schema=public
      - DATABASE_SAVE_DATA_INSTANCE=true
      - DATABASE_SAVE_DATA_NEW_MESSAGE=true
      - DATABASE_SAVE_DATA_CONTACTS=true
      - DATABASE_SAVE_DATA_CHATS=true
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://evolution-redis:6379/0
      - CACHE_REDIS_PREFIX_KEY=evolution
      - CACHE_REDIS_SAVE_INSTANCES=true
      - LOG_LEVEL=ERROR
      - LOG_BAILEYS=error
      - QRCODE_LIMIT=30
      - TZ=${GENERIC_TIMEZONE}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.evolution.rule=Host(`whatsapp.${DOMAIN_NAME}`)"
      - "traefik.http.routers.evolution.entrypoints=websecure"
      - "traefik.http.routers.evolution.tls.certresolver=mytlschallenge"
      - "traefik.http.services.evolution.loadbalancer.server.port=8080"
      - "traefik.http.middlewares.evolution-cors.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE,OPTIONS"
      - "traefik.http.middlewares.evolution-cors.headers.accesscontrolalloworiginlist=*"
      - "traefik.http.routers.evolution.middlewares=evolution-cors"
    volumes:
      - evolution_instances:/evolution/instances

  evolution-redis:
    image: redis:7-alpine
    restart: always
    command: redis-server --appendonly yes
    volumes:
      - evolution_redis_data:/data

  evolution-postgres:
    image: postgres:15-alpine
    restart: always
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=evolution
    volumes:
      - evolution_postgres_data:/var/lib/postgresql/data

  nginx-rtmp:
    image: alfg/nginx-rtmp:latest
    container_name: nginx-rtmp
    restart: always
    ports:
      - "1935:1935"
      - "8080:80"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.rtmp.rule=Host(`stream.${DOMAIN_NAME}`)"
      - "traefik.http.routers.rtmp.entrypoints=websecure"
      - "traefik.http.routers.rtmp.tls=true"
      - "traefik.http.routers.rtmp.tls.certresolver=mytlschallenge"
      - "traefik.http.services.rtmp.loadbalancer.server.port=80"
      - "traefik.http.middlewares.rtmp-cors.headers.accesscontrolallowmethods=GET,OPTIONS"
      - "traefik.http.middlewares.rtmp-cors.headers.accesscontrolallowheaders=*"
      - "traefik.http.middlewares.rtmp-cors.headers.accesscontrolalloworiginlist=*"
      - "traefik.http.routers.rtmp.middlewares=rtmp-cors"

  # Chatwoot - Descomentado para uso futuro
  # Para ativar, configure CHATWOOT_DB_PASSWORD e CHATWOOT_REDIS_PASSWORD no .env
  # chatwoot-postgres:
  #   image: postgres:14
  #   restart: always
  #   environment:
  #     POSTGRES_DB: chatwoot_production
  #     POSTGRES_USER: chatwoot
  #     POSTGRES_PASSWORD: ${CHATWOOT_DB_PASSWORD}
  #   volumes:
  #     - chatwoot_postgres:/var/lib/postgresql/data

  # chatwoot-redis:
  #   image: redis:6
  #   restart: always
  #   command: ["redis-server", "--requirepass", "${CHATWOOT_REDIS_PASSWORD}"]
  #   volumes:
  #     - chatwoot_redis:/data

  # chatwoot:
  #   image: chatwoot/chatwoot:v3.0.0
  #   restart: always
  #   depends_on:
  #     - chatwoot-postgres
  #     - chatwoot-redis
  #   env_file: .env
  #   environment:
  #     RAILS_ENV: production
  #     POSTGRES_HOST: chatwoot-postgres
  #     POSTGRES_DATABASE: chatwoot_production
  #     POSTGRES_USERNAME: chatwoot
  #     POSTGRES_PASSWORD: ${CHATWOOT_DB_PASSWORD}
  #     REDIS_URL: redis://:${CHATWOOT_REDIS_PASSWORD}@chatwoot-redis:6379
  #     FRONTEND_URL: https://chatwoot.${DOMAIN_NAME}
  #     FORCE_SSL: "true"
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.chatwoot.rule=Host(`chatwoot.${DOMAIN_NAME}`)"
  #     - "traefik.http.routers.chatwoot.entrypoints=websecure"
  #     - "traefik.http.routers.chatwoot.tls.certresolver=mytlschallenge"
  #     - "traefik.http.services.chatwoot.loadbalancer.server.port=3000"

  # chatwoot-worker:
  #   image: chatwoot/chatwoot:v3.0.0
  #   restart: always
  #   depends_on:
  #     - chatwoot-postgres
  #     - chatwoot-redis
  #   env_file: .env
  #   environment:
  #     RAILS_ENV: production
  #     POSTGRES_HOST: chatwoot-postgres
  #     POSTGRES_DATABASE: chatwoot_production
  #     POSTGRES_USERNAME: chatwoot
  #     POSTGRES_PASSWORD: ${CHATWOOT_DB_PASSWORD}
  #     REDIS_URL: redis://:${CHATWOOT_REDIS_PASSWORD}@chatwoot-redis:6379
  #     FRONTEND_URL: https://chatwoot.${DOMAIN_NAME}
  #   command: ["bundle", "exec", "sidekiq"]

volumes:
  traefik_data:
  n8n_data:
  evolution_instances:
  evolution_redis_data:
  evolution_postgres_data:
  # chatwoot_postgres:
  # chatwoot_redis:
